{"description": "### Impact\n\nAll Hail Batch clusters are affected. An attacker is able to:\n\n1. Create one or more accounts with Hail Batch without corresponding real accounts in the organization.\n\nFor example, a user could create a Microsoft or Google account and then change their email to \"inconspicuous@example.org\". This Microsoft or Google account can then be used to create a Hail Batch account in Hail Batch clusters whose organization domain is \"example.org\".\n\nIn Google, this attack is partially mitigated because Google requires users to verify ownership of their Google account. However, a valid user is able to create multiple distinct Hail Batch accounts by creating multiple distinct Google accounts using email addresses of the form \"real_user_email_name+random_id@example.org\".\n\nIn Microsoft, this attack requires Azure AD Administrator access to an Azure AD Tenant. The Azure AD Administrator is permitted to change the email address of an account to any other email address without verification. An attacker can create an Azure Tenant for free.\n\n1. The attacker *does not* have access to any private data (because the new service principals or service accounts are not granted any privileges).\n3. If trial Hail Batch billing projects are enabled, the attacker *does* have the ability to run jobs and thus spend money. An attacker can create as many accounts as Microsoft or Google permit.\n4. The attacker *cannot* impersonate another user because, in Azure, we use the `sub` from the OAuth2 response, and, in Google, Google does an email verification.\n\n### Remediation\n\n1. Apply this patch to prevent third-party attackers from creating accounts.\n2. Audit your users list https://auth.example.org/users for user accounts whose login ids are not valid login ids with your identity provider. Delete such users.\n\nA forthcoming change will prevent users from creating multiple accounts using Google's `+` email redirection.\n\n### Workarounds\nNone.\n\n### References\n1. https://trufflesecurity.com/blog/google-oauth-is-broken-sort-of/\n2. https://www.descope.com/blog/post/noauth\n4. https://developers.google.com/identity/openid-connect/openid-connect#an-id-tokens-payload\n5. https://learn.microsoft.com/en-us/entra/identity-platform/access-token-claims-reference#payload-claims\n\n[1] Hail Batch must separately stop using emails and start using the OAuth2 `sub` in Google. This is a known deficiency. In particular, if an email is re-used by the organization for a new user, the new user could access the old user's Hail Batch account.", "methods": ["Used OAuth2 to verify user domain validity.", "Used email claims to verify user domain validity.", "Created multiple accounts with Hail Batch without corresponding real accounts in the organization.", "Used email address spoofing to create multiple accounts.", "Used Azure AD Administrator access to change email addresses without verification.", "Used OAuth2 to create service principals or service accounts.", "Used email verification to prevent impersonation.", "Used OAuth2 to grant privileges to new service principals or service accounts.", "Used email verification to prevent impersonation.", "Used Azure AD Administrator access to create new Azure Tenants.", "Used OAuth2 to create multiple accounts with Google.", "Used email address redirection to create multiple accounts with Google.", "Used OAuth2 to create multiple accounts with Microsoft.", "Used Azure AD Administrator access to change email addresses without verification.", "Used OAuth2 to create service principals or service accounts with privileges.", "Used email verification to prevent impersonation.", "Used OAuth2 to create multiple accounts with Hail Batch.", "Used email address spoofing to create multiple accounts with Hail Batch."]}