{"description": "### Summary\n\nThe way the proxy protocol listener is implemented in sshpiper can allow an attacker to forge their connecting address.\n\n### Details\n\n[This commit](https://github.com/tg123/sshpiper/commit/2ddd69876a1e1119059debc59fe869cb4e754430) added the proxy protocol listener as the only listener in sshpiper, with no option to toggle this functionality off. This means that any connection that sshpiper is directly (or in some cases indirectly) exposed to can use proxy protocol to forge its source address.\n\n### PoC\n\nYou can use a configuration like this in HAProxy:\n\n```\nlisten w-send-proxy\n    mode tcp\n    log global\n    option tcplog\n    bind *:27654\n    tcp-request connection set-src ipv4(1.1.1.1)\n    server app1 ssh-piper-hostname:22 send-proxy\n```\n\nWhen connecting through HAProxy, sshpiper will log connections as originating from `1.1.1.1`.  The proxy protocol data is designed to survive multiple load balancers or proxies and pass through to sshpiper at the end, so it should only be enabled trusted environments. This should be behind a configuration option or startup flag to prevent abuse when public connections can be made to sshpiper.\n\nThis is also backed up by [the specification for proxy protocol](https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt):\n\n> The receiver MUST be configured to only receive the protocol described in this\nspecification and MUST not try to guess whether the protocol header is present\nor not. This means that the protocol explicitly prevents port sharing between\npublic and private access. Otherwise it would open a major security breach by\nallowing untrusted parties to spoof their connection addresses. The receiver\nSHOULD ensure proper access filtering so that only trusted proxies are allowed\nto use this protocol.\n\n### Impact\n\nAny users of sshpiper who need logs from it for whitelisting/rate limiting/security investigations could have them become much less useful if an attacker is sending a spoofed source address.", "methods": ["Used a vulnerability in the proxy protocol implementation to fake the source address.", "Failed to implement proper access filtering to prevent untrusted parties from spoofing their connection addresses.", "Enabled a feature without proper flagging, allowing for potential abuse.", "Failed to ensure proper access control to prevent unauthorized use of the proxy protocol."]}